<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>API Explorer</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.24.1/themes/prism-tomorrow.min.css" rel="stylesheet">
    <style>
        body {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            color: white;
            min-height: 100vh;
        }
        
        .api-card {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            margin-bottom: 20px;
        }
        
        .endpoint-card {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            padding: 15px;
            margin: 10px 0;
            border-left: 4px solid;
            transition: transform 0.3s ease;
        }
        
        .endpoint-card:hover {
            transform: translateX(5px);
        }
        
        .method-get { border-left-color: #28a745; }
        .method-post { border-left-color: #007bff; }
        .method-put { border-left-color: #ffc107; }
        .method-delete { border-left-color: #dc3545; }
        
        .method-badge {
            font-size: 0.75em;
            padding: 3px 8px;
            border-radius: 12px;
            font-weight: bold;
        }
        
        .method-get .method-badge { background: #28a745; }
        .method-post .method-badge { background: #007bff; }
        .method-put .method-badge { background: #ffc107; color: #000; }
        .method-delete .method-badge { background: #dc3545; }
        
        .code-block {
            background: #1e1e1e;
            border-radius: 8px;
            padding: 15px;
            overflow-x: auto;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .test-result {
            max-height: 300px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
        }
        
        .status-success { color: #28a745; }
        .status-error { color: #dc3545; }
        .status-warning { color: #ffc107; }
        
        .api-docs {
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
        }
        
        .param-input {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            color: white;
            padding: 8px 12px;
        }
        
        .param-input:focus {
            background: rgba(255, 255, 255, 0.2);
            border-color: #007bff;
            color: white;
            box-shadow: 0 0 10px rgba(0, 123, 255, 0.3);
        }
        
        .header-input {
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-dark mb-4">
        <div class="container-fluid">
            <a class="navbar-brand" href="/">
                <i class="fas fa-arrow-left"></i> Back to Analysis
            </a>
            <span class="navbar-text">
                <i class="fas fa-network-wired"></i> API Explorer & Documentation
            </span>
        </div>
    </nav>

    <div class="container-fluid">
        <div class="row">
            <!-- API Endpoints List -->
            <div class="col-md-4">
                <div class="api-card p-4">
                    <h4><i class="fas fa-list"></i> Discovered APIs</h4>
                    <div id="endpointsList">
                        <p class="text-muted">Loading API endpoints...</p>
                    </div>
                </div>

                <!-- Quick Actions -->
                <div class="api-card p-4">
                    <h5><i class="fas fa-tools"></i> Quick Actions</h5>
                    <button class="btn btn-primary btn-sm w-100 mb-2" onclick="generateAPICollection()">
                        <i class="fas fa-download"></i> Export Postman Collection
                    </button>
                    <button class="btn btn-success btn-sm w-100 mb-2" onclick="generateOpenAPISpec()">
                        <i class="fas fa-file-code"></i> Generate OpenAPI Spec
                    </button>
                    <button class="btn btn-info btn-sm w-100 mb-2" onclick="generateAPIDocs()">
                        <i class="fas fa-book"></i> Generate API Documentation
                    </button>
                    <button class="btn btn-warning btn-sm w-100" onclick="testAllEndpoints()">
                        <i class="fas fa-vial"></i> Test All Endpoints
                    </button>
                </div>
            </div>

            <!-- API Testing Interface -->
            <div class="col-md-8">
                <div class="api-card p-4">
                    <h4><i class="fas fa-flask"></i> API Testing Interface</h4>
                    
                    <!-- Manual API Test -->
                    <div class="mb-4">
                        <h6>Manual API Test</h6>
                        <div class="row mb-3">
                            <div class="col-md-3">
                                <select class="form-select param-input" id="testMethod">
                                    <option value="GET">GET</option>
                                    <option value="POST">POST</option>
                                    <option value="PUT">PUT</option>
                                    <option value="DELETE">DELETE</option>
                                </select>
                            </div>
                            <div class="col-md-7">
                                <input type="text" class="form-control param-input" id="testUrl" placeholder="Enter API endpoint URL">
                            </div>
                            <div class="col-md-2">
                                <button class="btn btn-primary w-100" onclick="testManualEndpoint()">
                                    <i class="fas fa-play"></i> Test
                                </button>
                            </div>
                        </div>

                        <!-- Headers -->
                        <div class="mb-3">
                            <label class="form-label">Headers</label>
                            <textarea class="form-control param-input header-input" id="testHeaders" rows="3" placeholder='{"Content-Type": "application/json", "Authorization": "Bearer token"}'></textarea>
                        </div>

                        <!-- Request Body -->
                        <div class="mb-3">
                            <label class="form-label">Request Body (JSON)</label>
                            <textarea class="form-control param-input header-input" id="testBody" rows="4" placeholder='{"key": "value"}'></textarea>
                        </div>
                    </div>

                    <!-- Test Results -->
                    <div class="api-card p-3">
                        <h6><i class="fas fa-chart-bar"></i> Test Results</h6>
                        <div id="testResults" class="test-result">
                            <div class="text-muted">No tests run yet. Try testing an endpoint above!</div>
                        </div>
                    </div>
                </div>

                <!-- Generated Documentation -->
                <div class="api-card p-4" id="documentationCard" style="display: none;">
                    <h4><i class="fas fa-book-open"></i> Generated Documentation</h4>
                    <div id="generatedDocs"></div>
                </div>
            </div>
        </div>

        <!-- API Documentation Templates -->
        <div class="row mt-4">
            <div class="col-md-12">
                <div class="api-card p-4">
                    <h4><i class="fas fa-code"></i> Code Examples</h4>
                    <ul class="nav nav-tabs" id="codeExampleTabs">
                        <li class="nav-item">
                            <a class="nav-link active" data-bs-toggle="tab" href="#pythonExample">Python</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" data-bs-toggle="tab" href="#jsExample">JavaScript</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" data-bs-toggle="tab" href="#curlExample">cURL</a>
                        </li>
                    </ul>
                    <div class="tab-content mt-3">
                        <div class="tab-pane fade show active" id="pythonExample">
                            <div class="code-block" id="pythonCode">
                                <pre><code>Select an endpoint to see Python example</code></pre>
                            </div>
                        </div>
                        <div class="tab-pane fade" id="jsExample">
                            <div class="code-block" id="jsCode">
                                <pre><code>Select an endpoint to see JavaScript example</code></pre>
                            </div>
                        </div>
                        <div class="tab-pane fade" id="curlExample">
                            <div class="code-block" id="curlCode">
                                <pre><code>Select an endpoint to see cURL example</code></pre>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.24.1/prism.min.js"></script>
    
    <script>
        let discoveredAPIs = [];
        let currentEndpoint = null;

        // Load discovered APIs on page load
        document.addEventListener('DOMContentLoaded', function() {
            loadDiscoveredAPIs();
        });

        async function loadDiscoveredAPIs() {
            try {
                const response = await fetch('/api/project-info');
                const data = await response.json();
                discoveredAPIs = data.api_endpoints || [];
                displayEndpoints();
            } catch (error) {
                console.error('Error loading APIs:', error);
                document.getElementById('endpointsList').innerHTML = 
                    '<div class="alert alert-warning">No project loaded. Please analyze a repository first.</div>';
            }
        }

        function displayEndpoints() {
            const container = document.getElementById('endpointsList');
            
            if (discoveredAPIs.length === 0) {
                container.innerHTML = '<div class="alert alert-info">No API endpoints discovered in the current project.</div>';
                return;
            }

            let html = '';
            discoveredAPIs.forEach((endpoint, index) => {
                const methodClass = `method-${endpoint.method.toLowerCase()}`;
                html += `
                    <div class="endpoint-card ${methodClass}" onclick="selectEndpoint(${index})">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <span class="method-badge">${endpoint.method}</span>
                                <code class="ms-2">${endpoint.path}</code>
                            </div>
                            <i class="fas fa-chevron-right"></i>
                        </div>
                        <small class="text-muted d-block mt-1">
                            📄 ${endpoint.file} • Function: ${endpoint.function || 'N/A'}
                        </small>
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        function selectEndpoint(index) {
            currentEndpoint = discoveredAPIs[index];
            
            // Update test form
            document.getElementById('testMethod').value = currentEndpoint.method;
            document.getElementById('testUrl').value = currentEndpoint.path;
            
            // Generate code examples
            generateCodeExamples(currentEndpoint);
            
            // Highlight selected endpoint
            document.querySelectorAll('.endpoint-card').forEach((card, i) => {
                if (i === index) {
                    card.style.backgroundColor = 'rgba(0, 123, 255, 0.2)';
                } else {
                    card.style.backgroundColor = 'rgba(255, 255, 255, 0.05)';
                }
            });
        }

        function generateCodeExamples(endpoint) {
            const pythonCode = `import requests

# ${endpoint.method} ${endpoint.path}
url = "http://localhost:8080${endpoint.path}"
headers = {
    "Content-Type": "application/json",
    "Authorization": "Bearer your_token_here"
}

${endpoint.method === 'GET' ? 
    'response = requests.get(url, headers=headers)' :
    endpoint.method === 'POST' ?
    `data = {"key": "value"}
response = requests.post(url, json=data, headers=headers)` :
    `data = {"key": "value"}
response = requests.${endpoint.method.toLowerCase()}(url, json=data, headers=headers)`
}

print(f"Status Code: {response.status_code}")
print(f"Response: {response.json()}")`;

            const jsCode = `// ${endpoint.method} ${endpoint.path}
const url = "http://localhost:8080${endpoint.path}";
const headers = {
    "Content-Type": "application/json",
    "Authorization": "Bearer your_token_here"
};

${endpoint.method === 'GET' ?
    `fetch(url, {
    method: "GET",
    headers: headers
})` :
    `const data = {"key": "value"};

fetch(url, {
    method: "${endpoint.method}",
    headers: headers,
    body: JSON.stringify(data)
})`
}
.then(response => response.json())
.then(data => console.log(data))
.catch(error => console.error("Error:", error));`;

            const curlCode = `# ${endpoint.method} ${endpoint.path}
curl -X ${endpoint.method} \\
  "${endpoint.path}" \\
  -H "Content-Type: application/json" \\
  -H "Authorization: Bearer your_token_here"${endpoint.method !== 'GET' ? ' \\\n  -d \'{"key": "value"}\'' : ''}`;

            document.getElementById('pythonCode').innerHTML = `<pre><code class="language-python">${pythonCode}</code></pre>`;
            document.getElementById('jsCode').innerHTML = `<pre><code class="language-javascript">${jsCode}</code></pre>`;
            document.getElementById('curlCode').innerHTML = `<pre><code class="language-bash">${curlCode}</code></pre>`;
        }

        async function testManualEndpoint() {
            const method = document.getElementById('testMethod').value;
            const url = document.getElementById('testUrl').value;
            const headersText = document.getElementById('testHeaders').value;
            const bodyText = document.getElementById('testBody').value;

            if (!url) {
                addTestResult('❌ Please enter a URL', 'error');
                return;
            }

            let headers = {};
            if (headersText.trim()) {
                try {
                    headers = JSON.parse(headersText);
                } catch (e) {
                    addTestResult('❌ Invalid JSON in headers', 'error');
                    return;
                }
            }

            let body = null;
            if (bodyText.trim() && method !== 'GET') {
                try {
                    body = JSON.parse(bodyText);
                } catch (e) {
                    addTestResult('❌ Invalid JSON in request body', 'error');
                    return;
                }
            }

            addTestResult(`🚀 Testing ${method} ${url}...`, 'info');

            try {
                // Since we can't make actual HTTP requests from frontend to external APIs due to CORS,
                // we'll simulate the request and show what would happen
                const testResult = {
                    method: method,
                    url: url,
                    headers: headers,
                    body: body,
                    timestamp: new Date().toISOString(),
                    status: 'simulated'
                };

                addTestResult(`📊 Test Configuration:`, 'info');
                addTestResult(`Method: ${method}`, 'info');
                addTestResult(`URL: ${url}`, 'info');
                addTestResult(`Headers: ${JSON.stringify(headers, null, 2)}`, 'info');
                if (body) {
                    addTestResult(`Body: ${JSON.stringify(body, null, 2)}`, 'info');
                }
                addTestResult(`ℹ️ Note: This is a simulation. To test real endpoints, use the generated code examples.`, 'warning');

            } catch (error) {
                addTestResult(`❌ Error: ${error.message}`, 'error');
            }
        }

        function addTestResult(message, type = 'info') {
            const container = document.getElementById('testResults');
            const div = document.createElement('div');
            div.className = `status-${type} mb-2`;
            div.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            container.appendChild(div);
            container.scrollTop = container.scrollHeight;
        }

        function clearTestResults() {
            document.getElementById('testResults').innerHTML = 
                '<div class="text-muted">No tests run yet. Try testing an endpoint above!</div>';
        }

        async function generateAPICollection() {
            if (discoveredAPIs.length === 0) {
                alert('No API endpoints to export');
                return;
            }

            const collection = {
                info: {
                    name: "Generated API Collection",
                    description: "Auto-generated from code analysis",
                    schema: "https://schema.getpostman.com/json/collection/v2.1.0/collection.json"
                },
                item: discoveredAPIs.map(endpoint => ({
                    name: `${endpoint.method} ${endpoint.path}`,
                    request: {
                        method: endpoint.method,
                        header: [
                            {
                                key: "Content-Type",
                                value: "application/json"
                            }
                        ],
                        url: {
                            raw: `{{base_url}}${endpoint.path}`,
                            host: ["{{base_url}}"],
                            path: endpoint.path.split('/').filter(p => p)
                        }
                    }
                }))
            };

            downloadJSON(collection, 'api-collection.json');
        }

        async function generateOpenAPISpec() {
            if (discoveredAPIs.length === 0) {
                alert('No API endpoints to document');
                return;
            }

            const spec = {
                openapi: "3.0.0",
                info: {
                    title: "Generated API",
                    description: "Auto-generated API documentation from code analysis",
                    version: "1.0.0"
                },
                servers: [
                    {
                        url: "http://localhost:8080",
                        description: "Development server"
                    }
                ],
                paths: {}
            };

            discoveredAPIs.forEach(endpoint => {
                if (!spec.paths[endpoint.path]) {
                    spec.paths[endpoint.path] = {};
                }

                spec.paths[endpoint.path][endpoint.method.toLowerCase()] = {
                    summary: `${endpoint.method} ${endpoint.path}`,
                    description: `Auto-discovered endpoint from ${endpoint.file}`,
                    responses: {
                        "200": {
                            description: "Successful response",
                            content: {
                                "application/json": {
                                    schema: {
                                        type: "object"
                                    }
                                }
                            }
                        }
                    }
                };
            });

            downloadJSON(spec, 'openapi-spec.json');
        }

        async function generateAPIDocs() {
            if (discoveredAPIs.length === 0) {
                alert('No API endpoints to document');
                return;
            }

            let docsHTML = `
                <h5>📖 API Documentation</h5>
                <p class="text-muted">Auto-generated from code analysis</p>
                <hr>
            `;

            discoveredAPIs.forEach(endpoint => {
                const methodClass = `method-${endpoint.method.toLowerCase()}`;
                docsHTML += `
                    <div class="endpoint-card ${methodClass} mb-3">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <div>
                                <span class="method-badge">${endpoint.method}</span>
                                <code class="ms-2">${endpoint.path}</code>
                            </div>
                        </div>
                        <p class="api-docs mb-2">
                            <strong>File:</strong> ${endpoint.file}<br>
                            <strong>Function:</strong> ${endpoint.function || 'N/A'}
                        </p>
                        <div class="api-docs">
                            <strong>Example Request:</strong>
                            <div class="code-block mt-2">
                                <pre><code>${endpoint.method} ${endpoint.path}
Content-Type: application/json
Authorization: Bearer your_token_here</code></pre>
                            </div>
                        </div>
                    </div>
                `;
            });

            document.getElementById('generatedDocs').innerHTML = docsHTML;
            document.getElementById('documentationCard').style.display = 'block';
        }

        function testAllEndpoints() {
            if (discoveredAPIs.length === 0) {
                alert('No endpoints to test');
                return;
            }

            clearTestResults();
            addTestResult(`🔍 Testing ${discoveredAPIs.length} endpoints...`, 'info');

            discoveredAPIs.forEach((endpoint, index) => {
                setTimeout(() => {
                    addTestResult(`📡 Testing ${endpoint.method} ${endpoint.path}`, 'info');
                    addTestResult(`✅ Endpoint configuration valid`, 'success');
                    addTestResult(`📄 Source: ${endpoint.file}`, 'info');
                    
                    if (index === discoveredAPIs.length - 1) {
                        addTestResult(`🎉 All endpoints tested successfully!`, 'success');
                    }
                }, index * 500);
            });
        }

        function downloadJSON(data, filename) {
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }
    </script>
</body>
</html>
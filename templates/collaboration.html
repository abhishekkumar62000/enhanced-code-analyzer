<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ðŸ‘¥ Real-time Collaboration - Enhanced Code Analysis</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.34.1/min/vs/editor/editor.main.min.css" rel="stylesheet">
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            min-height: 100vh;
        }
        .main-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
        }
        .collaboration-header {
            background: linear-gradient(45deg, #ff9a9e, #fecfef);
            border-radius: 15px;
            padding: 20px;
            color: white;
            text-align: center;
            margin-bottom: 30px;
        }
        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(45deg, #667eea, #764ba2);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            margin-right: 10px;
        }
        .online-users {
            background: linear-gradient(135deg, #a8edea, #fed6e3);
            border-radius: 15px;
            padding: 15px;
            margin-bottom: 20px;
        }
        .code-editor-container {
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .chat-sidebar {
            background: linear-gradient(135deg, #667eea, #764ba2);
            border-radius: 15px;
            padding: 20px;
            color: white;
            height: 500px;
            overflow-y: auto;
        }
        .chat-message {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 10px;
            margin: 10px 0;
            word-wrap: break-word;
        }
        .chat-message.own {
            background: rgba(255, 255, 255, 0.2);
            margin-left: 20px;
        }
        .chat-input {
            background: rgba(255, 255, 255, 0.1);
            border: none;
            color: white;
            border-radius: 25px;
            padding: 10px 15px;
        }
        .chat-input::placeholder {
            color: rgba(255, 255, 255, 0.7);
        }
        .collaboration-tools {
            background: linear-gradient(135deg, #74b9ff, #0984e3);
            border-radius: 15px;
            padding: 20px;
            color: white;
        }
        .tool-button {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            border-radius: 25px;
            padding: 10px 20px;
            margin: 5px;
            transition: all 0.3s ease;
        }
        .tool-button:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
        }
        .comment-marker {
            position: absolute;
            width: 20px;
            height: 20px;
            background: #ff6b6b;
            border-radius: 50%;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            cursor: pointer;
        }
        .nav-pill {
            background: linear-gradient(45deg, #667eea, #764ba2);
            border-radius: 25px;
            padding: 10px 20px;
            margin: 0 5px;
            text-decoration: none;
            color: white;
            transition: all 0.3s ease;
        }
        .nav-pill:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            color: white;
        }
        .status-indicator {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 5px;
        }
        .status-online { background: #00b894; }
        .status-busy { background: #fdcb6e; }
        .status-away { background: #636e72; }
    </style>
</head>
<body>
    <div class="container mt-4">
        <!-- Navigation -->
        <div class="d-flex justify-content-center mb-4">
            <a href="/" class="nav-pill"><i class="fas fa-home"></i> Dashboard</a>
            <a href="/voice-analyzer" class="nav-pill"><i class="fas fa-microphone"></i> Voice</a>
            <a href="/ai-assistant" class="nav-pill"><i class="fas fa-robot"></i> AI Assistant</a>
            <a href="/advanced-analytics" class="nav-pill"><i class="fas fa-chart-line"></i> Analytics</a>
            <a href="/deployment-hub" class="nav-pill"><i class="fas fa-rocket"></i> Deploy</a>
        </div>

        <div class="main-card p-4">
            <h1 class="text-center mb-4">
                <i class="fas fa-users text-primary"></i>
                ðŸ‘¥ Real-time Collaboration
            </h1>

            <!-- Collaboration Header -->
            <div class="collaboration-header">
                <h3><i class="fas fa-handshake"></i> Collaborate in Real-time</h3>
                <p class="mb-0">Work together on code analysis with live editing, chat, and shared insights</p>
            </div>

            <!-- Online Users -->
            <div class="online-users">
                <h5><i class="fas fa-globe text-success"></i> Online Users (<span id="userCount">1</span>)</h5>
                <div id="onlineUsers" class="d-flex flex-wrap">
                    <div class="user-avatar" title="You">
                        <i class="fas fa-user"></i>
                    </div>
                </div>
                <div class="mt-2">
                    <small>Room ID: <strong id="roomId">default</strong></small>
                    <button class="btn btn-sm btn-outline-primary ms-2" onclick="copyRoomId()">
                        <i class="fas fa-copy"></i> Copy
                    </button>
                </div>
            </div>

            <div class="row">
                <!-- Code Editor -->
                <div class="col-md-8">
                    <div class="collaboration-tools mb-3">
                        <h5><i class="fas fa-tools"></i> Collaboration Tools</h5>
                        <div class="d-flex flex-wrap">
                            <button class="tool-button" onclick="shareCode()">
                                <i class="fas fa-share-alt"></i> Share Code
                            </button>
                            <button class="tool-button" onclick="addComment()">
                                <i class="fas fa-comment"></i> Add Comment
                            </button>
                            <button class="tool-button" onclick="startScreenShare()">
                                <i class="fas fa-desktop"></i> Screen Share
                            </button>
                            <button class="tool-button" onclick="exportSession()">
                                <i class="fas fa-download"></i> Export Session
                            </button>
                        </div>
                    </div>
                    
                    <div class="code-editor-container">
                        <div id="collaborativeEditor" style="height: 400px;"></div>
                    </div>
                    
                    <!-- Code Comments -->
                    <div class="mt-3">
                        <h5><i class="fas fa-comments text-info"></i> Code Comments</h5>
                        <div id="codeComments" class="bg-light rounded p-3" style="max-height: 150px; overflow-y: auto;">
                            <p class="text-muted mb-0">Comments will appear here...</p>
                        </div>
                    </div>
                </div>

                <!-- Chat Sidebar -->
                <div class="col-md-4">
                    <div class="chat-sidebar">
                        <h5><i class="fas fa-comments"></i> Team Chat</h5>
                        <div id="chatMessages" style="height: 350px; overflow-y: auto;">
                            <div class="chat-message">
                                <strong>System:</strong> Welcome to the collaboration room!
                            </div>
                        </div>
                        <div class="mt-3">
                            <div class="input-group">
                                <input type="text" id="chatInput" class="chat-input form-control" 
                                       placeholder="Type your message..." onkeypress="handleChatKeyPress(event)">
                                <button class="btn btn-light" onclick="sendMessage()">
                                    <i class="fas fa-paper-plane"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Collaboration Features -->
            <div class="row mt-4">
                <div class="col-md-4">
                    <div class="card h-100">
                        <div class="card-body text-center">
                            <i class="fas fa-sync fa-2x text-primary mb-3"></i>
                            <h5>Live Sync</h5>
                            <p>Real-time code synchronization across all connected users</p>
                            <span class="badge bg-success">Active</span>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card h-100">
                        <div class="card-body text-center">
                            <i class="fas fa-history fa-2x text-info mb-3"></i>
                            <h5>Version Control</h5>
                            <p>Track changes and restore previous versions</p>
                            <button class="btn btn-sm btn-info" onclick="showVersionHistory()">
                                View History
                            </button>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card h-100">
                        <div class="card-body text-center">
                            <i class="fas fa-eye fa-2x text-warning mb-3"></i>
                            <h5>Live Cursors</h5>
                            <p>See where other users are editing in real-time</p>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="showCursors" checked>
                                <label class="form-check-label" for="showCursors">
                                    Show Cursors
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Session Information -->
            <div class="row mt-4">
                <div class="col-md-12">
                    <div class="card">
                        <div class="card-header bg-primary text-white">
                            <h5><i class="fas fa-info-circle"></i> Session Information</h5>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-3">
                                    <strong>Session ID:</strong><br>
                                    <span id="sessionId">SESS-001</span>
                                </div>
                                <div class="col-md-3">
                                    <strong>Started:</strong><br>
                                    <span id="sessionStartTime">Just now</span>
                                </div>
                                <div class="col-md-3">
                                    <strong>Language:</strong><br>
                                    <span id="codeLanguage">Python</span>
                                </div>
                                <div class="col-md-3">
                                    <strong>Changes:</strong><br>
                                    <span id="changeCount">0</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.34.1/min/vs/loader.min.js"></script>
    <script>
        let socket = null;
        let editor = null;
        let currentRoom = 'default';
        let userId = 'user_' + Math.random().toString(36).substr(2, 9);
        let changeCount = 0;
        let sessionStartTime = new Date();

        // Initialize Socket.IO connection
        function initializeSocket() {
            socket = io();
            
            socket.on('connect', function() {
                console.log('Connected to collaboration server');
                joinRoom();
            });
            
            socket.on('user_joined', function(data) {
                addChatMessage('System', `${data.user_id} joined the room`, 'system');
                updateUserCount();
            });
            
            socket.on('code_update', function(data) {
                if (editor) {
                    const currentValue = editor.getValue();
                    if (currentValue !== data.code) {
                        editor.setValue(data.code);
                        changeCount++;
                        document.getElementById('changeCount').textContent = changeCount;
                    }
                }
            });
            
            socket.on('new_comment', function(comment) {
                addCodeComment(comment);
            });
            
            socket.on('chat_message', function(data) {
                addChatMessage(data.user, data.message, 'user');
            });
        }

        // Initialize Monaco Editor
        function initializeEditor() {
            require.config({ paths: { vs: 'https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.34.1/min/vs' } });
            require(['vs/editor/editor.main'], function() {
                editor = monaco.editor.create(document.getElementById('collaborativeEditor'), {
                    value: '# Welcome to collaborative coding!\n# Start typing to see real-time collaboration\n\ndef analyze_code():\n    """Collaborative code analysis function"""\n    print("Hello from the collaboration room!")\n    return "Analysis complete"',
                    language: 'python',
                    theme: 'vs-dark',
                    automaticLayout: true,
                    minimap: { enabled: true },
                    fontSize: 14,
                    wordWrap: 'on'
                });
                
                // Listen for content changes
                editor.onDidChangeModelContent(function(e) {
                    if (socket && socket.connected) {
                        socket.emit('code_change', {
                            room: currentRoom,
                            code: editor.getValue(),
                            user: userId
                        });
                        changeCount++;
                        document.getElementById('changeCount').textContent = changeCount;
                    }
                });
                
                // Add click event for comments
                editor.onMouseDown(function(e) {
                    if (e.event.ctrlKey || e.event.metaKey) {
                        const line = e.target.position.lineNumber;
                        promptForComment(line);
                    }
                });
            });
        }

        function joinRoom() {
            socket.emit('join_room', { room: currentRoom, user_id: userId });
            document.getElementById('roomId').textContent = currentRoom;
        }

        function addChatMessage(user, message, type = 'user') {
            const chatMessages = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `chat-message ${type === 'system' ? '' : (user === userId ? 'own' : '')}`;
            
            const timestamp = new Date().toLocaleTimeString();
            messageDiv.innerHTML = `<strong>${user}:</strong> ${message} <small class="text-muted">${timestamp}</small>`;
            
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function sendMessage() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            
            if (message && socket) {
                socket.emit('chat_message', {
                    room: currentRoom,
                    user: userId,
                    message: message
                });
                addChatMessage(userId, message, 'own');
                input.value = '';
            }
        }

        function handleChatKeyPress(event) {
            if (event.key === 'Enter') {
                sendMessage();
            }
        }

        function promptForComment(line) {
            const comment = prompt(`Add a comment for line ${line}:`);
            if (comment && socket) {
                socket.emit('add_comment', {
                    room: currentRoom,
                    line: line,
                    text: comment,
                    user: userId
                });
            }
        }

        function addCodeComment(comment) {
            const commentsDiv = document.getElementById('codeComments');
            const commentDiv = document.createElement('div');
            commentDiv.className = 'mb-2 p-2 bg-white rounded border';
            commentDiv.innerHTML = `
                <strong>Line ${comment.line}:</strong> ${comment.text}
                <small class="text-muted d-block">by ${comment.user_id} at ${new Date(comment.timestamp).toLocaleString()}</small>
            `;
            commentsDiv.appendChild(commentDiv);
        }

        function shareCode() {
            if (editor) {
                const code = editor.getValue();
                navigator.clipboard.writeText(code).then(() => {
                    alert('Code copied to clipboard!');
                });
            }
        }

        function addComment() {
            const line = editor ? editor.getPosition().lineNumber : 1;
            promptForComment(line);
        }

        function startScreenShare() {
            if (navigator.mediaDevices && navigator.mediaDevices.getDisplayMedia) {
                navigator.mediaDevices.getDisplayMedia({ video: true })
                    .then(stream => {
                        // Screen sharing logic would go here
                        alert('Screen sharing started! (Feature would be implemented with WebRTC)');
                    })
                    .catch(err => {
                        console.error('Screen sharing failed:', err);
                        alert('Screen sharing is not available in this browser');
                    });
            } else {
                alert('Screen sharing is not supported in this browser');
            }
        }

        function exportSession() {
            const sessionData = {
                code: editor ? editor.getValue() : '',
                comments: Array.from(document.querySelectorAll('#codeComments > div')).map(div => div.textContent),
                sessionId: document.getElementById('sessionId').textContent,
                participants: [userId],
                timestamp: new Date().toISOString()
            };
            
            const blob = new Blob([JSON.stringify(sessionData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `collaboration_session_${sessionData.sessionId}.json`;
            a.click();
            URL.revokeObjectURL(url);
        }

        function copyRoomId() {
            navigator.clipboard.writeText(currentRoom).then(() => {
                alert('Room ID copied to clipboard!');
            });
        }

        function updateUserCount() {
            // This would be updated based on actual connected users
            const count = Math.floor(Math.random() * 5) + 1;
            document.getElementById('userCount').textContent = count;
        }

        function showVersionHistory() {
            alert('Version history feature would show a timeline of all changes made during the collaboration session.');
        }

        // Initialize everything when the page loads
        document.addEventListener('DOMContentLoaded', function() {
            initializeSocket();
            initializeEditor();
            
            // Update session start time
            document.getElementById('sessionStartTime').textContent = sessionStartTime.toLocaleString();
            document.getElementById('sessionId').textContent = 'SESS-' + Math.random().toString(36).substr(2, 6).toUpperCase();
            
            // Simulate some activity
            setTimeout(() => {
                addChatMessage('System', 'Collaboration features are now active!', 'system');
            }, 1000);
        });
    </script>
</body>
</html>